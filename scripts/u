#!/bin/bash

# Color Definitions
BLACK='\033[0;39m'
BLUE='\033[1;34m'
GREEN='\033[1;32m'
RED='\033[1;31m'
GREY='\033[1;30m'

# Functions
function display_header() {
    clear
    toilet "KickPi-OS" --metal
    echo -e "$GREY KickPI-OS ROM Operating System and Libraries"
    echo " Version V2.0 2020-2021 KickPi-OS "
    echo " No Rights Reserved.  "
}

function check_free_space() {
    df -k --output=avail "$PWD" | tail -n1
}

function cleanup_files() {
    local paths=("$@")
    for path in "${paths[@]}"; do
        echo "  ... deleting files from $path"
        sudo find "$path" -name "$1" -type f -print0 | xargs -0 rm -f
    done
}

function main() {
    cd
    display_header

    if [ -d /OLED/ ]; then
        KickPi-OS.sh
    fi

    sudo rm -rf ~/KickPi-OS
    echo -e "$BLACK Check free disk space..."
    echo -e "$BLUE "
    df -H -l /root

    local FREE=$(check_free_space)

    if [[ $FREE -lt 5000000 ]]; then
        echo -e "$RED Not enough disk space! Deleting unnecessary files..."
        
        # Cleanup directories
        cleanup_files "\._*" "_UAEFSDB.*" ".DS_Store" "*.mpg"
        
        echo "  ... cleanup finished."
        df -H -l /root
        sleep 3
        
        # Deleting specific directories
        if [ -d /home/$USER/pimiga15/disks/Work/Videos/ ]; then
            echo -e "$BLUE Deleting Pimiga15 Videos..."
            sudo rm -rf /home/$USER/pimiga15/disks/Work/Videos/*
        fi
        if [ -d /home/$USER/pimiga15/disks/Work/Amiga_CD_Collection/ ]; then
            echo -e "$BLUE Deleting Amiga_CD_Collections..."
            sudo rm -rf /home/$USER/pimiga15/disks/Work/Commodore_Amiga_Tosec_Complete/Demos/
            sudo rm -rf /home/$USER/pimiga15/disks/Work/Commodore_Amiga_Tosec_Complete/Demos/Demos.info
        fi
    fi

    # Further cleanup and updates
    sudo dpkg --configure -a
    display_header
    sudo apt -y --fix-broken install
    sudo apt-get autoremove
    sudo apt-get autoclean
    sudo apt-get clean
    display_header

    # Update KickPi-OS
    wget -q --spider http://google.com
    if [ $? -eq 0 ]; then
        cd
        sudo rm -rf /home/$USER/KickPi-OS_up/
        git clone --depth=1 https://github.com/Jodels2002/KickPi-OS_up.git 
       

        if [ ! -d /opt/Backup/ ]; then
            sudo mkdir /opt/Backup/
        fi
        
        sudo cp -f -R /home/$USER/KickPi-OS_up/scripts/* /usr/local/bin
        sudo cp -f -R /home/$USER/KickPi-OS_up/ /opt/KickPi-OS
        sudo chmod -R 777 /usr/local/bin
        sudo chmod -R 777 /opt/KickPi-OS
        sudo rm -rf /home/$USER/KickPi-OS_up/
        pikickme.sh
    else
        whiptail --msgbox " Sorry, you must first connect to the internet ..." 20 50 1
    fi
}

main
